# .htaccess について

今更ですが、`.htaccess` の記述方法についての覚書を記します。

## .htaccess とは

Apache HTTPサーバの動作をフォルダごとに変更するための設定ファイルです。

アクセス制限や、リライト(文字列変換してURLを制御する)などに使用することが多いようです。

## htaccess の制限など

- `.htaccess` の書き方にはルールがあり、ルールを違反すると "500 internal server error" が発生します。
- ファイル名の頭に「.」があります。これは隠しファイルを意味します。
- 環境によって頭に「.」がついたファイル名を許可していない場合がありますので、その場合は、他のファイル名にしておいてからWebサーバーにアップロード後リネームします。
- 行頭に「#」を記述するとコメントアウト行になります。(行の途中にコメントするのは避けたほうがいいようです。)
- 文字コードはUTF-8(BOM無し)、改行コードはLFを設定し、ファイルの最終行には空行を入れる必要があります。(Windowsなどでは、編集ソフトによってBOM付になるので注意)

## httpd.conf

`httpd.conf` は、`.htaccess` の上位設定ファイルです。
`httpd.conf` で、使用許可がないと `.htaccess` は使用できません。

OSによって、場所やファイル名が異なるので注意。

- CentOS = `/etc/httpd/conf/httpd.conf`
- Ubuntu = `/etc/apache2/conf.d`
- Mac = `/etc/apache2/httpd.conf`
- Windows(2.2系) = `C:\Program Files (x86)\Apache software Foundation\pache2.2\conf\httpd.conf`

※ `/etc/apache2/sites-available/000-default.conf` `conf/extra/httpd-default.conf` のように別ファイルに個別設定を書くことがあります。

`httpd.conf` の途中に下記のような記述があります。

```xml
Include conf.d/*.conf
```

これは、`conf.d` ディレクトリ以下の `*.conf` を読み込むことになります。
(`Include` 以前の記述を上書きできますが、`Include` 以下の記述は上書きされないので注意。)

### .htaccess の有効化

`httpd.conf` で、DocumentRoot 以下の `.htaccess` を有効化させるには、下記のように `AllowOverride All` にします。 (下記は、他の設定を省略しています。)

```xml
<Directory "/var/www/html" >
AllowOverride All
</Directory>
```

## 正規表現によるディレティブ

正規表現を使って、入力されたURLから、指定されるディレクトリを表示させることが可能です。

例えば、`https://???.???.???/` でリクエストがあった場合に `/page/front/index.php` を表示させるなどが可能です。

`/wp/` にインストールしている Wordpress に、DocumentRoot(`/`)のアクセスを転送するようなときに使用します。

通常、リクエストされる文字列を正規表現でマッチングさせて置換するような方法が使用されますので、正規表現が重要になります。

### 基本的な正規表現

|文字|説明|
|:--:|:-|
| \. | 任意の1文字 にマッチします。 |
| \+ | 直前の文字が 1回以上 繰り返す場合にマッチします。<br>"go\+gle" は "gogle" や "google" にはマッチしますが "ggle" にはマッチしません。 |
| \* | 直前の文字が 0回以上 繰り返す場合にマッチします。<br>"go\*gle" は "gogle" や "google" や "ggle" にマッチします。 |
| \? | 直前の文字が 0個か1個 ある場合にマッチします。<br>"go\?gle" は "gogle" や "ggle" にマッチしますが "google" にはマッチしません。 |
| ^(カレット) | 直後の文字が行の 先頭 にある場合にマッチします。<br>"\^google" は行の先頭に "google" の文字がある場合にマッチします。 |
| \$ | 直前の文字が行の 末尾 にある場合にマッチします。<br>"google\$" は行の末尾に "google" の文字がある場合にマッチします。 |
| \| | 選択肢を区切るために使われます。<br>"google\|googol" は "google" と "googol" にマッチします。<br>"goog(le\|ol)" と表記しても同様の結果を得られます。 |
| \\ | 直後の "正規表現において特別な意味を持つ" 文字を エスケープ する。<br>"go\\\+gle" は "go\+gle" にマッチします。正規表現における "\+" の意味を失い "\+" 文字として扱います。 |
| [ ] | 角括弧に含まれる文字のいずれか1つにマッチします。<br>[abcXYZ01] は "a" , "b" , "c" , "X" , "Y" , "Z" , "0" , "1" にマッチします。<br>角括弧内の文字を "\-" を使って範囲指定のマッチもできます。<br>[a\-cX\-Z0\-1] は "a" , "b" , "c" , "X" , "Y" , "Z" , "0" , "1" にマッチします。<br>角括弧内の先頭に "^" を使って含まれない文字のマッチもできます。<br>[\^abc] は "a" , "b" , "c" 以外の文字にマッチします。 |
| ( ) | 文字の集合を1つのグループにまとめて扱うことができます。<br>(google)\+ は "google" を1つの単位として評価するため "google" にマッチします。<br>また、マッチング文字列は後述する "後方参照" として利用できます。 |
| {n,m} | 直前の文字、またはグループの桁数を指定してマッチ判定します。<br>a{3} は a が3桁、つまり "aaa" にマッチします。<br>a{3,5} は a が3～5桁、つまり "aaa" , "aaaa" , "aaaaa" にマッチします。<br>a{3,} は a が3桁以上にマッチします。 |

### 定義済みの正規表現クラス

| 文字 | 対応する表現 | 説明 |
|:--:|:--:|:--|
| \d | [0-9] | すべての数字 |
| \D | [^0-9] | すべての数字以外の文字 |
| \s | [ \t\f\r\n] | 垂直タブ以外のすべての空白文字 |
| \S | [^ \t\f\r\n] | すべての非空白文字 |
| \w | [a-zA-Z_0-9] | アルファベット、アンダーバー、数字 |
| \W | [^a-zA-Z_0-9] | アルファベット、アンダーバー、数字以外の文字 |
| [:digit:] | [0-9] | すべての数字 |
| [:lower:] | [a-z] | 小文字のアルファベット |
| [:upper:] | [A-Z] | 大文字のアルファベット |
| [:alpha:] | [a-zA-Z] | アルファベット |
| [:xdigit:] | [0-9A-Fa-f] | 16進数で使われる数字とアルファベット |
| [:alnum:] | [a-zA-Z0-9] | アルファベットと数字 |
| [:punct:] | [.,!?:...] | 句読点文字 |
| [:cntrl:] | (なし) | 制御文字 |
| [:blank:] | [ \t] | 空白文字とタブ |
| [:graph:] | [^\n\r\f\v] | 印字文字 |
| [:space:] | [ \t\n\r\f\v] | 改行を含む空白文字 |

### mod_rewrite

多くのWebサーバーで採用されているモジュールです。

下記のディレクティブが含まれています。

- RewriteEngine
- RewriteBase
- RewriteRule
- RewriteCond
- RewriteOptions

#### RewriteEngine

RewriteEngine ディレクティブは、URL の書き換えを行うエンジンです。
URL の書き換え処理を行う場合は、On にする必要があります。

```xml
RewriteEngine On
```

#### RewriteBase

RewriteBase ディレクティブは、指定するリダイレクト先の URL のベースとなるディレクトリを相対パスで指定するものです。
.htaccess が置かれたディレクトリからの相対パスとなります。

**注意:** RewriteBase が影響するのは RewriteRule のリダイレクト先のパスだけです。

```xml
RewriteBase /path
# RewriteBase で変更された URL は index.php にのみ影響します。
RewriteRule path/index.html index.php [R=301,L]
```

下記のようにすると、どのディレクトリのindex.htmlにアクセスしても、`/path/index.php`のアクセスになります。

```xml
RewriteRule index.html index.php [R=301,L]
```

#### RewriteRule

RewriteRule ディレクティブは、URL の書き換えを行うディレクティブです。

```xml
# RewriteRule 条件 置換文字列 [フラグ]
RewriteRule page1.html page2.html [L]
```

**注意:** 下記の例では、[L] が機能しないようで無限ループになります。
(httpd.conf では有効ですが、.htaccess 無効)

```xml
RewriteRule page1.html page2.html [L]
RewriteRule page2.html page3.html [L]
```

無限ループを防ぐためにも、RewriteCond を使用するようにしましょう。

##### RewriteRule で利用可能なフラグ一覧

| フラグ | シンタックス | 説明 |
|:--:|:--:|:--|
| B | － | 書き換え処理の前に英数字以外の文字をエスケープ(パーセントエンコーディング)します。 |
| C | chain | 条件に一致したら、次の行に書かれた処理を連続して行います。これは通常の動作となるため、このフラグの用途は、条件が不一致の場合に後続の条件をスキップするために使われます。 |
| CO=NAME:VAL | Cookie | Cookie を設定できます。 |
| DPI | discardpath | URI の PATH_INFO を破棄します。このフラグは、Apache 2.2.12 以降で利用可能です。 |
| E | ENV | 環境変数の値を設定できます。値を設定する場合は [E=VAR:VAL]、値を削除する場合は [E=!VAL] とします。VAR は変数名、VAL は変数です。(例：[E=hoge:123]) |
| F | forbidden | HTTP 403(Forbidden：閲覧禁止)エラーを返します。以降のルールは実行しません。 |
| G | gone | HTTP 410(Gone：消滅)エラー [3] を返します。以降のルールは実行しません。 |
| H=Content-handler | Handler | 実行するアプリケーションのハンドラを強制的に指定します。例えば、拡張子のないファイルをすべて php アプリケーションとして実行するには、以下のように記述します。<br>RewriteRule !\\. - [H=application/x-httpd-php] |
| L | last | URLの書き換え処理を終了します。以降のルールは実行しません。 |
| N | next | 書き換え処理を先頭から再実行します。その際にマッチングされる URL は最後に書き換えられた URL となります。無限ループを引き起こさないように注意して下さい。 |
| NC | nocase | 条件を評価する時、英字の大文字小文字を区別しません。 |
| NE | noescape | & や % をエスケープせずそのままの文字列として扱います。 |
| NS | nosubreq | サーバ内部で発生するサブリクエストには、書き換え処理を行いません。 |
| P | proxy | 強制的に置換対象部を内部的にプロキシリクエストとして、プロキシモジュールを通して出力します。置換文字列は、http:// から始まるようなプロキシモジュールで扱える有効な URI である必要があります。無効な URI を指定した場合は、エラーが返されます。ただし、このフラグを使用する場合は、mod_proxy が組み込まれている必要があります。 |
| PT | passthrough | RewriteRule ディレクティブのターゲット(または、置換文字列)は、ファイルパスを想定していますが、代わりに URI として処理を行います。Alias、Redirect、ScriptAlias ディレクティブを利用する際に指定します。 |
| QSA | qsappend | 書き換え前の URL と置換文字列に、それぞれクエリ文字列(URL の ? 以降の文字列)が存在する場合、置換文字列の末尾に & と書き換え前の URL に指定されたクエリ文字列を追加します。本フラグを指定しない場合、クエリ文字列は置換文字列で上書きされます。 |
| R[=code] | redirect | 指定したURLにリダイレクトします。[R=301] のようにレスポンスコードを指定することもできます。指定できるレスポンスコードの範囲は 300 ～ 399 までとなります。それ以外のレスポンスコードを指定した場合は、置換文字列が破棄されます。レスポンスコードを指定しない場合は 302(Found) になります。また、temp(デフォルト値)、permanent、seeother のシンボル名も指定できます。 |
| S=num | skip | 指定した数のルールをスキップします。例えば、[S=2] と指定すると、条件に一致した場合、以降のルールを 2 つスキップします。 |
| T=MIME-type | type | ターゲットファイルを強制的に指定した MIME-type にします。|

###### レスポンスコード

HTTP レスポンスステータスコード は、成功 200 OK や 500 Internal Server Error などサーバーからクライアントに発行するステータスを表現するコードです。

[R=300] など、リダイレクトに関わるコードは下記のようになります。

|コード|ステータス|説明|
|:--:|:--:|:--|
| 300 | Multiple Choice | リクエストに対して複数のレスポンスがあることを示します。ユーザーエージェントやユーザーは、それらからひとつを選択します。 (複数のレスポンスからひとつを選ぶ方法は標準化されていませんが、選択肢へリンクする HTML が推奨されており、それによってユーザーが選択することができます。) |
| 301 | Moved Permanently | リクエストされたリソースの URL が永遠に変更されたことを示します。レスポンスで新しい URL が与えられます。 |
| 302 | Found | このレスポンスコードは、リクエストされたリソースの URI が一時的に変更されたことを示します。URI は将来、新たに変更される可能性があります。従って、クライアントは将来のリクエストでも同じ URI を使用するべきです。 |
| 303 | See Other | サーバーはこのレスポンスを、リクエストされたリソースを別の URI で GET リクエストを使用して取得するようクライアントを誘導するために送信します。 |

#### RewriteCond

RewriteRuleの書き換えルールの条件を定義できます。
RewriteRuleの前に設置でき、複数行の場合、オプションで OR を選択できます。(省略時は、AND)
条件を満たさない場合は、直後の RewriteRuleを実行しないので無限ループが避けられます。

```xml
# RewriteCond テスト文字列 条件 オプション
RewriteCond %{HTTP_HOST} ^(www\.)?hoge\.fuga\.co\.jp$ [NC]
# RewriteRule 条件 置換文字列 [フラグ]
RewriteRule .* http://hoge.com%{REQUEST_URI} [R=301,L]
```

一般的な上下の流れとは異なり、下記のような順で判定、実行されます。

例えば、`http://www.hobe.co.jp/page.html` にアクセスした場合、下記のような判定で `http://hoge.com/page.html` にリダイレクトされます。

1. `.*` (すべてのリクエスト文字列)
1. `%{HTTP_HOST}` が `^(www\.)?hoge\.co\.jp$ [NC]` にマッチするか(大文字小文字を無視) 
1. `http://hoge.com%{REQUEST_URI} [R=301,L]` `http://hoge.com/page.html` にリダイレクト

`.*` は URL を書き換えるかの条件であるため、`.*` を `http://hoge.com%{REQUEST_URI}` で置換するという意味ではありません。

##### 条件に利用できるパターン

| パターン | 説明 |
|:--:|:--|
| ! | テスト文字列が条件と不一致である場合、true を返す |
| ＜ | テスト文字列を数値、または辞書順として大小比較を行い小さい場合、true を返す |
| ＞ | テスト文字列を数値、または辞書順として大小比較を行い大きい場合、true を返す |
| = | テスト文字列を数値、または辞書順として等価比較を行い等しい場合、true を返す |
| -d | テスト文字列のディレクトリが存在する場合、true を返す |
| -f | テスト文字列のファイルが存在する場合、true を返す |
| -s | テスト文字列のファイルが存在し、サイズが0byteでない場合、true を返す |
| -l | テスト文字列がシンボリックリンクである場合、true を返す |
| -x | テスト文字列に対して実行権限がある場合、true を返す |
| -F | テスト文字列に対してアクセス可能なパスである場合、true を返す |
| -U | テスト文字列に対してアクセス可能なURLである場合、true を返す |

##### 条件を評価する時のオプション

| オプション | 説明 |
|:--:|:--|
| [OR] | 連続する RewriteCond のいずれかが true の場合に実行する。省略時は、連続する RewriteCond がすべて true の場合に実行する。|
| [NC] | 条件を評価する時、大文字小文字を区別しない。|

#### RewriteOptions

サーバ単位、またはディレクトリ単位にオプションを設定できます。

##### RewriteOptions に指定可能な値

| 値 | 説明|
|:--:|:--|
| inherit | 上位ディレクトリの設定の継承が強制されるため、上位ディレクトリの設定が下位ディレクトリより優先して実行されます。|
| AllowAnyURI | どのような URI も書き換えることが可能になります。mod_rewrite の脆弱性の修正を行ったことで発生した互換性の問題を回避するためのオプションです。特別な事情がない限り、使用することは非推奨です。|
| MergeBase | RewriteBaseの設定が下位ディレクトリにも継承されます。|

