# VS Code / Docker / Xdebug

VS Code をメインの開発環境とし、Docker 上で動作している環境の Xdebug について、導入まで苦労したので、覚書として残します。

## はじめに

cakePHPなどのフレームワークを触る機会が多くなり、Xdebugのお世話になることが多くなってきました。

WEBサイトをリロードしてPHPの動きを追えるのは本当にありがたい。

しかし VS Code / Docker / Xdebug を組み合わせる上で、考えるべき要素が多く落ち着くまでに結構な時間を要しました。

とくに問題となったのは「どこで動かすか」ということでした。

## どこで動かすか

エディターは、VS Code。

自分のMac または、会社の Windows で運用です。

ここで、選択肢として2つ考える必要があります。

一体どこの Xdebug を使用するのか・・・。

Xdebug は、PHP 上で動くモジュールなので、PHPが動作している環境の必要があります。

でも、Mac は PHP が動いてますし、もちろん Docker でも動いてます。

Windows は、PHPをインストールすれば同様になります。

## Xdebug をローカル環境で運用

Mac や Windows に PHP が入っているなら、ローカルで Xdebug を動かすのがいいのかもしれません。

Docker の中で Git 管理ができない(理由は後述します)ので、必然的に Windows の Git を使用することになります。
VS Code 内で Git の操作をしたい場合、ローカルの Xdebug を使用するほうがいいでしょう。

ただし、複数の環境を持っている場合・・・たとえば、プロジェクトA は PHP7、プロジェクトBは PHP5 など違ったバージョンで運用が必要な場合 Docker はいいとして、ローカルの PHP 環境をいちいち切り替えるのも面倒ということもあります。

また PHP 導入に関しては Mac の場合もとから PHP が動くので問題ありませんが Windows の場合はちょっと考える必要があります。

### PHP 導入について

#### Windows

Windows に PHP をインストールするのか WSL にインストールするのか・・・。

僕の理解では WSL は Windows の中で Linux を動かすための仮想環境のようなものと考えています。

そこに PHP をインストールすればいいようにも思いますがフォルダーの位置が深いところにできてしまうとか Docker と Windows の関係に1つ加わるので、ちょっと遠回りでわかりにくいような気もします。

また、Docker自体の立ち上げる場所も、WSL 内でインストールして立ち上げるのか、Docker For Windows を使うのか・・・。

かなり幅広い選択肢が出てきます。

結局、僕の環境では Docker For Windows を使用して PHP は Windows に入れました。

#### Mac

Mac はもともと PHP が動きますので、とくにすることはありませんが、home brew で PHP7 を入れてしまったので、phpenv で環境を変更しました。

ちなみに、Docker は Docker For Mac がデフォルトスタンダードだと思います。
ちょっと前まで、Vagrant で Docker を立ち上げたほうが早いと言うようなこともありましたが、今はあまり違和感なく Docker For Mac で使えています。

## Git 管理について

前述しましたが Git は基本的に Docker 内で使用しないので、Windows や Mac ローカルの Git で運用することになります。
Docker の中で Git 管理しても、再構築する際に壊れますし、永続化部分のみの Git 管理も考えられますが Docker 環境をステージングなど他の環境に移行する際、じゃまになるのでやめたほうが良さそうです。

したがって Docker 関連ファイルを `docker` などのフォルダーにまとめる必要があり、その親で Git 初期化を行います。

これによって Docker 内に入って Git を使用できなくなるので、ターミナルや SourceTree などの管理ツールを使ってローカル環境でGit 管理する必要があります。

VS Code で Git の履歴や編集箇所を確認しようとすると、ローカル環境で VS Code を起動させる必要がありますが、複数の環境を運用する際には、Docker に入って作業を行いたいところです。

僕は、この問題が一番の悩みどころになりました。

## Xdebug を Docker 環境で運用

Windows に PHP を入れない場合でも、Dockerの中なら関係ないので普通に使用可能なので便利です。

PHP環境を意識しなくてもいいので、Git の運用の問題さえなければこちらを選択したほうがいいでしょう。

また、cakePHPなどのフレームワークではターミナルでコマンド操作などを行うことがあると思いますが、ローカル環境からコマンド操作を行おとするとターミナルを立ち上げて `docker-compose exec phpfpm bash`(phpfpm は docker-compose.yml で定義したサービス名) とかで Docker 内に入ってから作業する感じになるので、ちょっと面倒です。

Docker 内であれば VS Code のターミナルが使用できるので便利です。

### Docker 内で VS Codeを使用する際の準備

Docker 内で VS Code を使いたい場合、拡張機能が必要です。

#### Remote - Containers

Microsoft 製の拡張機能です。

![Remote - Containers](https://github.com/amano7/TIL/blob/master/etc/images/20200618-01.png?raw=true)

Docker を起動しておいて、左下の「><」アイコンをクリックすると「Attach To Running Container」を選ぶとコンテナー一覧が出るので、その中から PHP が動作しているコンテナーを選ぶと接続できます。

![Remote - Containers](https://github.com/amano7/TIL/blob/master/etc/images/20200618-02.png?raw=true)

## 設定について

PHP が問題なく動作しており、Xdebug のインストールと設定が終わっていることが、前提となります。

また、Xdebug を動かすために **PHP Debug** という拡張機能が必要になります。

設定ファイル(launch.json) は、下記のようになりました。

```json
{
    // IntelliSense を使用して利用可能な属性を学べます。
    // 既存の属性の説明をホバーして表示します。
    // 詳細情報は次を確認してください: https://go.microsoft.com/fwlink/?linkid=830387
    "version": "0.2.0",
    "configurations": [
        {
            "name": "Listen for XDebug",
            "type": "php",
            "request": "launch",
            "port": 9000,
            // {docker上のdocument root}:{ローカルのdocument root}
            "pathMappings": {"/var/www/html/cms" : "${workspaceRoot}"}
        },
    ]
}
```

php.ini には、下記の項目を設定します。

Docker 内で、Xdebug を使用する際には `xdebug.remote_host=localhost` にします。

ローカル環境からDocker内の Xdebug を使用する際は`xdebug.remote_host=IPアドレス` にします。
IPアドレスの代わりに`host.docker.internal`を使用すると、自動的に Docker のIPアドレスが設定されるので便利です。

```php
xdebug.remote_enable=1
xdebug.remote_autostart=1
; ホスト側のIP
; host.docker.internalはdockerのhostマシンのIPを解決してくれます。
xdebug.remote_host=localhost,
xdebug.remote_port= 9000
xdebug.remote_log = /var/log/xdebug.log
xdebug.var_display_max_children = -1
xdebug.var_display_max_data = -1
xdebug.var_display_max_depth = -1
```

### ハマリポイント

**launch.json** : pathMappings を設定しないと、僕の環境では認識してくれませんでした。
**php.ini** : xdebug.remote_port= 9000 が launch.json と合っていないと動きません。
**php.ini** : xdebug.remote_host=localhost ローカル環境は`localhost` ではなく`host.docker.internal`にしなければならない。

とくに、他の人と開発している場合 Git の更新で php.ini が更新されて気が付かないことがありました。Dockerを起動し直すとデバッグができなくなり、かなり時間を消費しました。

## 結局どうしたか

cakePHP の shell 開発で VS Code のターミナルを使用する頻度が高かったことと、Git 管理を SourceTree で行っているということで、今現在 VS Code を Docker 内で使用しています。

ただ VS Code で Git の管理がやりやすいし、わかりやすいのでここ最近ちょっと揺れています。

とくに、ファイル単位で修正履歴がまとまって見られる Git Lens (拡張機能) は、ローカル環境じゃないと使えないので悩みどころです。

試しに、ローカル環境にしてみようと考えています。
