# Docker で Xdebug

cakePHPなどのフレームワークを触る機会が多くなり、Xdebugのお世話になることが多くなってきました。

WEBサイトをリロードしてPHPの動きを追えるのは本当にありがたい。

しかし、導入までちょっと苦労したので、覚書として残します。

ちなみに、開発環境は色々あると思いますが、今は Docker を使用しています。

## どこで動かすか

エディターは、VS Code。
自分のMac または、会社の Windows で運用です。

ここで、選択肢として2つ考える必要があります。

一体どこの Xdebug を使用するのか・・・。

Xdebug は、PHP 上で動くモジュールなので、PHPが動作している環境の必要があります。

でも、Mac は PHP が動いてますし、もちろん Docker でも動いてます。

Windows は、PHPをインストールすれば同様になります。

## Xdebug をローカル環境で運用

Mac や Windows に PHP が入っているなら、ローカルで Xdebug を動かすのがいいのかもしれません。

Docker の中で Git 管理ができない(理由は後述します)ので、必然的に Windows の Git を使用することになります。
VS Code 内で Git の操作をしたい場合、ローカルの Xdebug を使用するほうがいいでしょう。

ただし、複数の環境を持っている場合・・・たとえば、プロジェクトA は PHP7、プロジェクトBは PHP5 など違ったバージョンで運用が必要な場合 Docker はいいとして、ローカルの PHP 環境をいちいち切り替えるのも面倒ということもあります。

また PHP 導入に関しては Mac の場合もとから PHP が動くので問題ありませんが Windows の場合はちょっと考える必要があります。

### PHP 導入について

#### Windows

Windows に PHP をインストールするのか WSL にインストールするのか・・・。

僕の理解では WSL は Windows の中で Linux を動かすための仮想環境のようなものと考えています。

そこに PHP をインストールすればいいようにも思いますがフォルダーの位置が深いところにできてしまうとか Docker と Windows の関係に1つ加わるので、ちょっと遠回りでわかりにくいような気もします。

また、Docker自体の立ち上げる場所も、WSL 内でインストールして立ち上げるのか、Docker For Windows を使うのか・・・。

かなり幅広い選択肢が出てきます。

結局、僕の環境では Docker For Windows を使用して PHP は Windows に入れました。

#### Mac

Mac はもともと PHP が動きますので、とくにすることはありませんが、home brew で PHP7 を入れてしまったので、phpenv で環境を変更しました。

ちなみに、Docker は Docker For Mac がデフォルトスタンダードだと思います。
ちょっと前まで、Vagrant で Docker を立ち上げたほうが早いと言うようなこともありましたが、今はあまり違和感なく Docker For Mac で使えています。

## Git 管理について

前述しましたが Git は基本的に Docker 内で使用しないので、Windows や Mac ローカルの Git で運用することになります。
Docker の中で Git 管理しても、再構築する際に壊れますし、永続化部分のみの Git 管理も考えられますが Docker 環境をステージングなど他の環境に移行する際、じゃまになるのでやめたほうが良さそうです。

したがって Docker 関連ファイルを `docker` などのフォルダーにまとめる必要があり、その親で Git 初期化を行います。

これによって Docker 内に入って Git を使用できなくなるので、ターミナルや SourceTree などの管理ツールを使ってローカル環境でGit 管理する必要があります。

VS Code で Git の履歴や編集箇所を確認しようとすると、ローカル環境で VS Code を起動させる必要がありますが、複数の環境を運用する際には、Docker に入って作業を行いたいところです。

僕は、この問題が一番の悩みどころになりました。

## Xdebug を Docker 環境で運用

Windows に PHP を入れない場合でも、Dockerの中なら関係ないので普通に使用可能なので便利です。

PHP環境を意識しなくてもいいので、Git の運用の問題さえなければこちらを選択したほうがいいでしょう。

また、cakePHPなどのフレームワークではターミナルでコマンド操作などを行うことがあると思いますが、ローカル環境からコマンド操作を行おとするとターミナルを立ち上げて `docker-compose exec phpfpm bash`(phpfpm は docker-compose.yml で定義したサービス名) とかで Docker 内に入ってから作業する感じになるので、ちょっと面倒です。

Docker 内であれば VS Code のターミナルが使用できるので便利です。

### Docker 内で VS Codeを使用する際の準備

Docker 内で VS Code を使いたい場合、拡張機能が必要です。

Remote - Containers
